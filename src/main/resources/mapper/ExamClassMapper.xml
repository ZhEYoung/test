<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.exam.mapper.ExamClassMapper">
    <!-- 基础列 -->
    <sql id="Base_Column_List">
        ec.ec_id, ec.exam_id, ec.class_id, ec.create_time
    </sql>

    <!-- 关联查询列 -->
    <sql id="Join_Column_List">
        ec.ec_id, ec.exam_id, ec.class_id, ec.create_time,
        e.exam_name, e.exam_start_time, e.exam_end_time, e.exam_duration, e.exam_status,
        c.class_name, c.teacher_id, c.subject_id
    </sql>

    <!-- 结果映射 -->
    <resultMap id="ExamClassResultMap" type="com.exam.entity.ExamClass">
        <id column="ec_id" property="ecId"/>
        <result column="exam_id" property="examId"/>
        <result column="class_id" property="classId"/>
        <result column="create_time" property="createTime"/>
        <!-- 关联考试信息 -->
        <association property="exam" javaType="com.exam.entity.Exam">
            <id column="exam_id" property="examId"/>
            <result column="exam_name" property="examName"/>
            <result column="exam_start_time" property="examStartTime"/>
            <result column="exam_end_time" property="examEndTime"/>
            <result column="exam_duration" property="examDuration"/>
            <result column="exam_status" property="examStatus"/>
        </association>
        <!-- 关联班级信息 -->
        <association property="clazz" javaType="com.exam.entity.Class">
            <id column="class_id" property="classId"/>
            <result column="class_name" property="className"/>
            <result column="teacher_id" property="teacherId"/>
            <result column="subject_id" property="subjectId"/>
        </association>
    </resultMap>

    <!-- 插入考试-班级关联记录 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="ecId">
        INSERT INTO exam_class (exam_id, class_id, create_time)
        VALUES (#{examId}, #{classId}, #{createTime})
    </insert>

    <!-- 批量插入考试-班级关联记录 -->
    <insert id="batchInsert" useGeneratedKeys="true" keyProperty="ecId">
        INSERT INTO exam_class (exam_id, class_id, create_time)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.examId}, #{item.classId}, #{item.createTime})
        </foreach>
    </insert>

    <!-- 根据ID删除考试-班级关联 -->
    <delete id="deleteById">
        DELETE FROM exam_class WHERE ec_id = #{ecId}
    </delete>

    <!-- 批量删除考试-班级关联 -->
    <delete id="batchDelete">
        DELETE FROM exam_class WHERE ec_id IN
        <foreach collection="ecIds" item="ecId" open="(" separator="," close=")">
            #{ecId}
        </foreach>
    </delete>

    <!-- 更新考试-班级关联信息 -->
    <update id="updateById">
        UPDATE exam_class
        <set>
            <if test="examId != null">exam_id = #{examId},</if>
            <if test="classId != null">class_id = #{classId},</if>
            <if test="createTime != null">create_time = #{createTime}</if>
        </set>
        WHERE ec_id = #{ecId}
    </update>

    <!-- 批量更新考试-班级关联 -->
    <update id="batchUpdate">
        <foreach collection="list" item="item" separator=";">
            UPDATE exam_class
            <set>
                <if test="item.examId != null">exam_id = #{item.examId},</if>
                <if test="item.classId != null">class_id = #{item.classId},</if>
                <if test="item.createTime != null">create_time = #{item.createTime}</if>
            </set>
            WHERE ec_id = #{item.ecId}
        </foreach>
    </update>

    <!-- 根据ID查询考试-班级关联 -->
    <select id="selectById" resultMap="ExamClassResultMap">
        SELECT <include refid="Join_Column_List" />
        FROM exam_class ec
        LEFT JOIN exam e ON ec.exam_id = e.exam_id
        LEFT JOIN class c ON ec.class_id = c.class_id
        WHERE ec.ec_id = #{ecId}
    </select>

    <!-- 查询所有考试-班级关联 -->
    <select id="selectAll" resultMap="ExamClassResultMap">
        SELECT <include refid="Join_Column_List" />
        FROM exam_class ec
        LEFT JOIN exam e ON ec.exam_id = e.exam_id
        LEFT JOIN class c ON ec.class_id = c.class_id
    </select>

    <!-- 分页查询考试-班级关联 -->
    <select id="selectPage" resultMap="ExamClassResultMap">
        SELECT <include refid="Join_Column_List" />
        FROM exam_class ec
        LEFT JOIN exam e ON ec.exam_id = e.exam_id
        LEFT JOIN class c ON ec.class_id = c.class_id
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 查询考试-班级关联总数 -->
    <select id="selectCount" resultType="java.lang.Long">
        SELECT COUNT(*) FROM exam_class
    </select>

    <!-- 条件查询考试-班级关联 -->
    <select id="selectByCondition" resultMap="ExamClassResultMap">
        SELECT <include refid="Join_Column_List" />
        FROM exam_class ec
        LEFT JOIN exam e ON ec.exam_id = e.exam_id
        LEFT JOIN class c ON ec.class_id = c.class_id
        <where>
            <foreach collection="condition" index="key" item="value" separator="AND">
                <if test="value != null">
                    ${key} = #{value}
                </if>
            </foreach>
        </where>
    </select>

    <!-- 条件查询考试-班级关联数量 -->
    <select id="selectCountByCondition" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM exam_class ec
        LEFT JOIN exam e ON ec.exam_id = e.exam_id
        LEFT JOIN class c ON ec.class_id = c.class_id
        <where>
            <foreach collection="condition" index="key" item="value" separator="AND">
                <if test="value != null">
                    ${key} = #{value}
                </if>
            </foreach>
        </where>
    </select>

    <!-- 条件分页查询考试-班级关联 -->
    <select id="selectPageByCondition" resultMap="ExamClassResultMap">
        SELECT <include refid="Join_Column_List" />
        FROM exam_class ec
        LEFT JOIN exam e ON ec.exam_id = e.exam_id
        LEFT JOIN class c ON ec.class_id = c.class_id
        <where>
            <foreach collection="condition" index="key" item="value" separator="AND">
                <if test="value != null">
                    ${key} = #{value}
                </if>
            </foreach>
        </where>
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 根据考试ID查询关联的班级列表 -->
    <select id="selectClassesByExamId" resultType="com.exam.entity.Class">
        SELECT c.*
        FROM class c
        INNER JOIN exam_class ec ON c.class_id = ec.class_id
        WHERE ec.exam_id = #{examId}
    </select>

    <!-- 根据班级ID查询关联的考试列表 -->
    <select id="selectExamsByClassId" resultType="com.exam.entity.Exam">
        SELECT e.*
        FROM exam e
        INNER JOIN exam_class ec ON e.exam_id = ec.exam_id
        WHERE ec.class_id = #{classId}
        ORDER BY e.exam_start_time
    </select>

    <!-- 根据考试ID和班级ID查询关联记录 -->
    <select id="selectByExamIdAndClassId" resultMap="ExamClassResultMap">
        SELECT <include refid="Join_Column_List" />
        FROM exam_class ec
        LEFT JOIN exam e ON ec.exam_id = e.exam_id
        LEFT JOIN class c ON ec.class_id = c.class_id
        WHERE ec.exam_id = #{examId}
        AND ec.class_id = #{classId}
    </select>

    <!-- 批量添加班级到考试 -->
    <insert id="batchAddClasses">
        INSERT INTO exam_class (exam_id, class_id, create_time)
        VALUES
        <foreach collection="classIds" item="classId" separator=",">
            (#{examId}, #{classId}, NOW())
        </foreach>
    </insert>

    <!-- 批量从考试中移除班级 -->
    <delete id="batchRemoveClasses">
        DELETE FROM exam_class
        WHERE exam_id = #{examId}
        AND class_id IN
        <foreach collection="classIds" item="classId" open="(" separator="," close=")">
            #{classId}
        </foreach>
    </delete>

    <!-- 查询指定时间范围内班级的考试 -->
    <select id="selectExamsByTimeRange" resultType="com.exam.entity.Exam">
        SELECT e.*
        FROM exam e
        INNER JOIN exam_class ec ON e.exam_id = ec.exam_id
        WHERE ec.class_id = #{classId}
        AND e.exam_start_time BETWEEN #{startTime} AND #{endTime}
        ORDER BY e.exam_start_time
    </select>

    <!-- 统计考试关联的班级数量 -->
    <select id="countClassesByExamId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM exam_class
        WHERE exam_id = #{examId}
    </select>

    <!-- 统计班级关联的考试数量 -->
    <select id="countExamsByClassId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM exam_class
        WHERE class_id = #{classId}
    </select>
</mapper>
